# <!-- Powered by BMADâ„¢ Core -->

# Story 7.13: Analytics & Tracking Integration

## Status

Draft

## Story

**As a** website owner,
**I want** to track user behavior and conversions,
**so that** I can optimize marketing and improve conversion rates.

## Acceptance Criteria

1. Google Analytics 4 (GA4) integrated with tracking ID in .env
2. GA4 tracking script loaded on all public pages
3. Custom events tracked: sign_up, subscription_start, survey_created
4. PostHog or Mixpanel integrated for product analytics
5. Conversion goals configured: registration, first survey, paid subscription
6. UTM parameters tracked for marketing campaigns
7. Privacy-compliant tracking with cookie consent banner
8. Cookie banner allows users to accept/reject analytics cookies (i18n: `Privacy.cookie_banner`)
9. Analytics opt-out respected (localStorage flag)
10. Tracking respects Do Not Track (DNT) browser setting
11. Dashboard for viewing key metrics (admin-only access)
12. All tracking notices and consent UI fully translated

## Tasks / Subtasks

- [ ] Set up Google Analytics 4 (AC: 1, 2)
  - [ ] Create GA4 property in Google Analytics
  - [ ] Add GA4 tracking ID to `.env` file (GA4_MEASUREMENT_ID)
  - [ ] Create GA4 tracking component `components/analytics/ga4-script.tsx`
  - [ ] Load GA4 script on all pages via root layout

- [ ] Track custom events (AC: 3)
  - [ ] Create event tracking helper `lib/analytics.ts`
  - [ ] Track `sign_up` event on registration success
  - [ ] Track `subscription_start` event on first subscription
  - [ ] Track `survey_created` event on first survey creation

- [ ] Set up PostHog or Mixpanel (AC: 4)
  - [ ] Choose analytics platform (PostHog or Mixpanel)
  - [ ] Add API key to `.env` file
  - [ ] Install SDK (`posthog-js` or `mixpanel-browser`)
  - [ ] Initialize in root layout
  - [ ] Track page views and custom events

- [ ] Configure conversion goals (AC: 5)
  - [ ] Set up registration conversion in GA4
  - [ ] Set up first survey conversion in GA4
  - [ ] Set up paid subscription conversion in GA4

- [ ] Track UTM parameters (AC: 6)
  - [ ] Capture UTM parameters from URL (utm_source, utm_medium, utm_campaign, utm_content, utm_term)
  - [ ] Store UTM parameters in session/localStorage
  - [ ] Associate UTM parameters with user registration

- [ ] Add cookie consent banner (AC: 7, 8)
  - [ ] Create cookie consent banner component `components/privacy/cookie-consent.tsx`
  - [ ] Display banner on first visit
  - [ ] Allow users to accept or reject analytics cookies
  - [ ] Store consent preference in localStorage
  - [ ] Only load analytics scripts if user has consented

- [ ] Implement analytics opt-out (AC: 9)
  - [ ] Check localStorage for analytics opt-out flag
  - [ ] Do not load analytics scripts if user has opted out
  - [ ] Provide opt-out link in privacy settings

- [ ] Respect Do Not Track (DNT) (AC: 10)
  - [ ] Check navigator.doNotTrack browser setting
  - [ ] Do not load analytics if DNT is enabled

- [ ] Create analytics dashboard (AC: 11)
  - [ ] Create `app/admin/analytics/page.tsx`
  - [ ] Restrict access to owner role only
  - [ ] Display key metrics: registrations, surveys created, subscriptions, pageviews
  - [ ] Fetch data from GA4 API or PostHog API
  - [ ] Display charts (use recharts or similar)

- [ ] Add internationalization strings (AC: 12)
  - [ ] Add EN translations to `locales/en.json`: Privacy.cookie_banner_*, Analytics.*
  - [ ] Add FR translations to `locales/fr.json`

- [ ] Testing and validation
  - [ ] Test GA4 script loads correctly
  - [ ] Test custom events are sent to GA4
  - [ ] Test PostHog/Mixpanel integration
  - [ ] Test cookie consent banner displays
  - [ ] Test analytics opt-out functionality
  - [ ] Test DNT respect
  - [ ] Verify analytics dashboard displays data
  - [ ] Test language switching (EN/FR)

## Dev Notes

### Epic Context

This is Story 7.13 in Epic 7: Marketing Website & Landing Pages. This story integrates analytics and tracking to measure user behavior and optimize marketing.

### Tech Stack

- **Framework**: Next.js 16 (App Router)
- **React**: 19
- **TypeScript**: 5.x
- **Analytics**: Google Analytics 4 (GA4)
- **Product Analytics**: PostHog or Mixpanel
- **Charts**: Recharts or Chart.js
- **i18n**: next-intl

### Source Tree

- GA4 script: `components/analytics/ga4-script.tsx`
- Analytics helper: `lib/analytics.ts`
- Cookie consent: `components/privacy/cookie-consent.tsx`
- Analytics dashboard: `app/admin/analytics/page.tsx`
- Root layout: `app/layout.tsx` (add GA4 and PostHog scripts)
- Environment: `.env` (GA4_MEASUREMENT_ID, NEXT_PUBLIC_POSTHOG_KEY)
- Translations: `locales/en.json` and `locales/fr.json`

### Google Analytics 4 Integration

**GA4 Script Component**:
```typescript
// components/analytics/ga4-script.tsx
'use client'

import Script from 'next/script'

export function GA4Script() {
  const GA4_ID = process.env.NEXT_PUBLIC_GA4_MEASUREMENT_ID

  if (!GA4_ID) return null

  return (
    <>
      <Script
        src={`https://www.googletagmanager.com/gtag/js?id=${GA4_ID}`}
        strategy="afterInteractive"
      />
      <Script id="google-analytics" strategy="afterInteractive">
        {`
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', '${GA4_ID}');
        `}
      </Script>
    </>
  )
}
```

**Event Tracking Helper**:
```typescript
// lib/analytics.ts
export const trackEvent = (eventName: string, eventParams?: Record<string, any>) => {
  if (typeof window !== 'undefined' && window.gtag) {
    window.gtag('event', eventName, eventParams)
  }
}

export const trackSignUp = () => trackEvent('sign_up')
export const trackSubscription = (plan: string) => trackEvent('subscription_start', { plan })
export const trackSurveyCreated = () => trackEvent('survey_created')
```

### PostHog Integration

```typescript
// app/layout.tsx or components/analytics/posthog-provider.tsx
'use client'

import posthog from 'posthog-js'
import { PostHogProvider } from 'posthog-js/react'

if (typeof window !== 'undefined') {
  posthog.init(process.env.NEXT_PUBLIC_POSTHOG_KEY!, {
    api_host: process.env.NEXT_PUBLIC_POSTHOG_HOST || 'https://app.posthog.com',
  })
}

export function PHProvider({ children }: { children: React.ReactNode }) {
  return <PostHogProvider client={posthog}>{children}</PostHogProvider>
}
```

### Cookie Consent Banner

```typescript
// components/privacy/cookie-consent.tsx
'use client'

import { useState, useEffect } from 'react'
import { Button } from '@/components/ui/button'

export function CookieConsent() {
  const [show, setShow] = useState(false)

  useEffect(() => {
    const consent = localStorage.getItem('cookie-consent')
    if (!consent) {
      setShow(true)
    }
  }, [])

  const acceptCookies = () => {
    localStorage.setItem('cookie-consent', 'accepted')
    setShow(false)
    // Load analytics scripts here
  }

  const rejectCookies = () => {
    localStorage.setItem('cookie-consent', 'rejected')
    setShow(false)
  }

  if (!show) return null

  return (
    <div className="fixed bottom-0 w-full bg-background border-t p-4 z-50">
      <div className="container mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
        <p className="text-sm">{/* i18n cookie banner text */}</p>
        <div className="flex gap-2">
          <Button onClick={acceptCookies}>Accept</Button>
          <Button variant="outline" onClick={rejectCookies}>Reject</Button>
        </div>
      </div>
    </div>
  )
}
```

### UTM Parameter Tracking

```typescript
// lib/utm.ts
export function captureUTMParameters() {
  if (typeof window === 'undefined') return

  const urlParams = new URLSearchParams(window.location.search)
  const utmParams = {
    utm_source: urlParams.get('utm_source'),
    utm_medium: urlParams.get('utm_medium'),
    utm_campaign: urlParams.get('utm_campaign'),
    utm_content: urlParams.get('utm_content'),
    utm_term: urlParams.get('utm_term'),
  }

  // Store in sessionStorage
  if (Object.values(utmParams).some(val => val !== null)) {
    sessionStorage.setItem('utm_params', JSON.stringify(utmParams))
  }
}
```

### Integration Points

- Add GA4 and PostHog scripts to `app/layout.tsx`
- Track events on registration (Epic 1), subscription (Epic 6), survey creation (Epic 2)
- Cookie consent banner on all pages
- Analytics dashboard accessible from admin nav

### Testing

**Test File Location**: `__tests__/analytics/*.test.tsx`

**Testing Standards**:
- Mock GA4 script loading
- Test event tracking functions
- Test cookie consent banner display and actions
- Test analytics opt-out functionality
- Test DNT respect
- Mock PostHog initialization
- Test i18n for both EN and FR

**Testing Frameworks**:
- Jest for test runner
- React Testing Library for component testing
- Mock window.gtag and posthog
- Mock localStorage and sessionStorage

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-06 | 1.0 | Initial story creation from Epic 7 | Sarah (PO Agent) |

## Dev Agent Record

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes

_To be filled by dev agent_

### File List

_To be filled by dev agent_

## QA Results

_To be filled by QA agent_
