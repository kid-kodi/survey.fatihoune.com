# <!-- Powered by BMAD™ Core -->

# Story 7.14: Performance Optimization

## Status

Draft

## Story

**As a** website visitor,
**I want** pages to load quickly and smoothly,
**so that** I have a great browsing experience.

## Acceptance Criteria

1. Next.js static generation used for landing, pricing, features, about pages
2. Images optimized with Next.js Image component (WebP format, lazy loading)
3. Critical CSS inlined for above-the-fold content
4. Non-critical CSS and JS deferred
5. Font optimization with next/font (local fonts, preload)
6. Code splitting implemented (separate bundles for marketing vs. app)
7. Lighthouse performance score > 90 for landing page
8. Lighthouse accessibility score > 95
9. Core Web Vitals pass: LCP < 2.5s, FID < 100ms, CLS < 0.1
10. CDN configured for static assets (images, CSS, JS)
11. Gzip/Brotli compression enabled
12. Browser caching headers configured
13. Service worker for offline support (optional)

## Tasks / Subtasks

- [ ] Enable static generation for marketing pages (AC: 1)
  - [ ] Ensure `/` (landing) uses `export const dynamic = 'force-static'` or default static
  - [ ] Ensure `/features` uses static generation
  - [ ] Ensure `/pricing` uses static generation
  - [ ] Ensure `/about` uses static generation
  - [ ] Use ISR (Incremental Static Regeneration) for blog pages if needed

- [ ] Optimize all images (AC: 2)
  - [ ] Replace all `<img>` tags with Next.js `<Image>` component
  - [ ] Configure automatic WebP conversion
  - [ ] Enable lazy loading for below-the-fold images
  - [ ] Set appropriate image sizes and srcset
  - [ ] Use blur placeholders for hero images

- [ ] Inline critical CSS (AC: 3)
  - [ ] Ensure critical CSS is automatically inlined by Next.js
  - [ ] Verify above-the-fold content renders without layout shift
  - [ ] Consider using `next/script` with `strategy="beforeInteractive"` for critical scripts

- [ ] Defer non-critical resources (AC: 4)
  - [ ] Use `next/script` with `strategy="afterInteractive"` or `strategy="lazyOnload"` for non-critical scripts
  - [ ] Defer analytics scripts (GA4, PostHog)
  - [ ] Lazy load below-the-fold components with React.lazy or Next.js dynamic imports

- [ ] Optimize fonts (AC: 5)
  - [ ] Use `next/font/google` or `next/font/local`
  - [ ] Preload fonts in layout
  - [ ] Use font-display: swap or optional
  - [ ] Subset fonts if possible

- [ ] Implement code splitting (AC: 6)
  - [ ] Separate marketing pages bundle from app bundle
  - [ ] Use Next.js automatic code splitting
  - [ ] Consider route-based code splitting for large components
  - [ ] Use dynamic imports for heavy components (charts, editors)

- [ ] Run Lighthouse audits (AC: 7, 8, 9)
  - [ ] Run Lighthouse on landing page
  - [ ] Optimize to achieve performance score > 90
  - [ ] Optimize to achieve accessibility score > 95
  - [ ] Ensure Core Web Vitals pass: LCP < 2.5s, FID < 100ms, CLS < 0.1
  - [ ] Address all Lighthouse recommendations

- [ ] Configure CDN for static assets (AC: 10)
  - [ ] Vercel automatically uses CDN, verify configuration
  - [ ] Ensure images, CSS, JS served from CDN
  - [ ] Configure custom domain if needed

- [ ] Enable compression (AC: 11)
  - [ ] Verify Gzip/Brotli compression enabled on Vercel
  - [ ] Test compression headers in production

- [ ] Configure caching headers (AC: 12)
  - [ ] Set long cache headers for static assets (images, CSS, JS)
  - [ ] Use `Cache-Control: public, max-age=31536000, immutable` for versioned assets
  - [ ] Configure Next.js headers in `next.config.js`

- [ ] Optional: Add service worker (AC: 13)
  - [ ] Consider using `next-pwa` for offline support
  - [ ] Cache static assets for offline viewing
  - [ ] Test offline functionality

- [ ] Testing and validation
  - [ ] Run Lighthouse audits on all marketing pages
  - [ ] Verify Core Web Vitals in Google Search Console
  - [ ] Test on various devices and network conditions
  - [ ] Use WebPageTest for detailed performance analysis
  - [ ] Verify images load correctly with lazy loading
  - [ ] Test font loading and FOUT/FOIT

## Dev Notes

### Epic Context

This is Story 7.14 in Epic 7: Marketing Website & Landing Pages. This story optimizes performance to ensure fast page loads and excellent user experience.

### Tech Stack

- **Framework**: Next.js 16 (App Router)
- **React**: 19
- **TypeScript**: 5.x
- **Image Optimization**: Next.js Image
- **Font Optimization**: next/font
- **Deployment**: Vercel (automatic CDN, compression, caching)

### Source Tree

- Next.js config: `next.config.js` (image optimization, headers)
- Font configuration: `app/layout.tsx` (next/font)
- Image components: Replace all `<img>` with `<Image>` across components
- Service worker (optional): `public/sw.js` or use `next-pwa`

### Next.js Static Generation

Ensure marketing pages use static generation:

```typescript
// app/page.tsx (landing)
export const dynamic = 'force-static' // or default

export default async function LandingPage() {
  // Static content
}
```

For blog posts with ISR:
```typescript
// app/blog/[slug]/page.tsx
export const revalidate = 3600 // Revalidate every hour

export async function generateStaticParams() {
  const posts = await prisma.blogPost.findMany({ select: { slug: true } })
  return posts.map((post) => ({ slug: post.slug }))
}
```

### Next.js Image Optimization

Replace all images:

```typescript
import Image from 'next/image'

<Image
  src="/hero-image.png"
  alt="Hero"
  width={1200}
  height={630}
  priority // For above-the-fold images
  placeholder="blur"
  blurDataURL="data:image/png;base64,..."
/>

// Below-the-fold images
<Image
  src="/feature-image.png"
  alt="Feature"
  width={800}
  height={600}
  loading="lazy" // Default
/>
```

### Font Optimization

Use next/font:

```typescript
// app/layout.tsx
import { Inter } from 'next/font/google'

const inter = Inter({
  subsets: ['latin'],
  display: 'swap',
  preload: true,
})

export default function RootLayout({ children }) {
  return (
    <html lang="en" className={inter.className}>
      <body>{children}</body>
    </html>
  )
}
```

### Code Splitting

Use dynamic imports for heavy components:

```typescript
import dynamic from 'next/dynamic'

const ChartComponent = dynamic(() => import('@/components/charts/chart'), {
  ssr: false,
  loading: () => <p>Loading chart...</p>,
})
```

### Caching Headers

Configure in `next.config.js`:

```javascript
module.exports = {
  async headers() {
    return [
      {
        source: '/:all*(svg|jpg|png|webp|gif|ico)',
        headers: [
          {
            key: 'Cache-Control',
            value: 'public, max-age=31536000, immutable',
          },
        ],
      },
    ]
  },
}
```

### Core Web Vitals Targets

- **LCP (Largest Contentful Paint)**: < 2.5s
- **FID (First Input Delay)**: < 100ms
- **CLS (Cumulative Layout Shift)**: < 0.1

### Lighthouse Optimization Checklist

- ✅ Minimize main-thread work
- ✅ Reduce JavaScript execution time
- ✅ Minimize critical request depth
- ✅ Reduce server response times
- ✅ Eliminate render-blocking resources
- ✅ Properly size images
- ✅ Serve images in next-gen formats (WebP, AVIF)
- ✅ Enable text compression
- ✅ Use efficient cache policy
- ✅ Avoid enormous network payloads

### Integration Points

- Applies to all marketing pages (Stories 7.1-7.11, 7.15)
- CDN and caching configured in Vercel deployment
- Fonts configured in root layout (Story 7.11)

### Testing

**Performance Testing Tools**:
- Google Lighthouse (Chrome DevTools)
- WebPageTest (https://www.webpagetest.org/)
- Google PageSpeed Insights (https://pagespeed.web.dev/)
- Chrome User Experience Report (CrUX)
- Vercel Analytics (if using Vercel)

**Testing Standards**:
- Run Lighthouse in incognito mode
- Test on 3G/4G network throttling
- Test on mobile and desktop
- Verify Core Web Vitals in field data (Google Search Console)
- Performance score > 90
- Accessibility score > 95
- Best Practices score > 90
- SEO score > 90

**Automated Testing**:
- Use Lighthouse CI in GitHub Actions to catch performance regressions
- Set performance budgets

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-06 | 1.0 | Initial story creation from Epic 7 | Sarah (PO Agent) |

## Dev Agent Record

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes

_To be filled by dev agent_

### File List

_To be filled by dev agent_

## QA Results

_To be filled by QA agent_
