# <!-- Powered by BMAD™ Core -->

# Story 7.17: Email Templates - Marketing & Transactional

## Status

Draft

## Story

**As a** user,
**I want** to receive professional, branded emails from the platform,
**so that** all communication feels cohesive and trustworthy.

## Acceptance Criteria

1. Email service configured (Resend or SendGrid) with API keys
2. React Email or MJML used for HTML email templates
3. **Welcome Email** template: sent on registration with getting started tips (EN/FR)
4. **Trial Expiring Email** template: sent 3 days before trial ends (EN/FR)
5. **Subscription Confirmation** email: sent after successful payment (EN/FR)
6. **Payment Failed** email: sent when payment fails with retry instructions (EN/FR)
7. **Contact Form** auto-reply: confirms inquiry received (EN/FR)
8. **Organization Invitation** email: sent when user invited to org (EN/FR) - already exists from Epic 5
9. All emails include header with logo and footer with unsubscribe link
10. Emails use brand colors and styling
11. Emails are mobile-responsive
12. Plain text version included for all emails
13. Unsubscribe functionality implemented (except critical transactional emails)
14. Email sending tracked (delivery, opens, clicks) via SendGrid/Resend dashboard

## Tasks / Subtasks

- [ ] Configure email service (AC: 1)
  - [ ] Choose email service: Resend or SendGrid
  - [ ] Sign up for service and get API key
  - [ ] Add API key to `.env` file (RESEND_API_KEY or SENDGRID_API_KEY)
  - [ ] Install SDK (`resend` or `@sendgrid/mail`)
  - [ ] Create email service wrapper in `lib/email.ts`

- [ ] Set up email template system (AC: 2)
  - [ ] Install React Email (`@react-email/components`)
  - [ ] Create `emails/` directory
  - [ ] Set up email preview dev server (optional)
  - [ ] Create base email layout component

- [ ] Create base email layout (AC: 9, 10, 11)
  - [ ] Create `emails/components/email-layout.tsx`
  - [ ] Add header with logo
  - [ ] Add footer with unsubscribe link, social links, copyright
  - [ ] Use brand colors
  - [ ] Ensure mobile-responsive design

- [ ] Create Welcome Email template (AC: 3)
  - [ ] Create `emails/welcome-email.tsx` (EN)
  - [ ] Create `emails/welcome-email-fr.tsx` (FR)
  - [ ] Include: welcome message, getting started tips, CTA to dashboard
  - [ ] Send on user registration

- [ ] Create Trial Expiring Email template (AC: 4)
  - [ ] Create `emails/trial-expiring-email.tsx` (EN)
  - [ ] Create `emails/trial-expiring-email-fr.tsx` (FR)
  - [ ] Include: trial expiration notice, subscription CTA
  - [ ] Schedule to send 3 days before trial ends

- [ ] Create Subscription Confirmation Email template (AC: 5)
  - [ ] Create `emails/subscription-confirmation-email.tsx` (EN)
  - [ ] Create `emails/subscription-confirmation-email-fr.tsx` (FR)
  - [ ] Include: confirmation, plan details, billing info, invoice
  - [ ] Send after successful payment

- [ ] Create Payment Failed Email template (AC: 6)
  - [ ] Create `emails/payment-failed-email.tsx` (EN)
  - [ ] Create `emails/payment-failed-email-fr.tsx` (FR)
  - [ ] Include: failure notice, retry instructions, update payment method link
  - [ ] Send when payment fails

- [ ] Create Contact Form Auto-Reply template (AC: 7)
  - [ ] Create `emails/contact-auto-reply-email.tsx` (EN)
  - [ ] Create `emails/contact-auto-reply-email-fr.tsx` (FR)
  - [ ] Include: confirmation of receipt, expected response time
  - [ ] Send immediately after contact form submission

- [ ] Verify Organization Invitation Email (AC: 8)
  - [ ] Check if email template exists from Epic 5
  - [ ] Ensure EN and FR versions exist
  - [ ] Update if needed to match new branding

- [ ] Add plain text versions (AC: 12)
  - [ ] Generate plain text version for each email template
  - [ ] Use React Email's text rendering or manual text versions

- [ ] Implement unsubscribe functionality (AC: 13)
  - [ ] Add unsubscribe link to email footer
  - [ ] Create `app/unsubscribe/page.tsx`
  - [ ] Create database field for email preferences (User model)
  - [ ] Respect unsubscribe for marketing emails (not transactional)

- [ ] Set up email sending functions (AC: 1, 14)
  - [ ] Create `lib/email.ts` with send functions
  - [ ] sendWelcomeEmail(user)
  - [ ] sendTrialExpiringEmail(user)
  - [ ] sendSubscriptionConfirmationEmail(user, subscription)
  - [ ] sendPaymentFailedEmail(user, error)
  - [ ] sendContactAutoReplyEmail(contactInfo)
  - [ ] Enable tracking (Resend/SendGrid automatically tracks)

- [ ] Testing and validation
  - [ ] Test all email templates render correctly
  - [ ] Send test emails to verify delivery
  - [ ] Test mobile-responsive design
  - [ ] Test both EN and FR versions
  - [ ] Verify plain text versions
  - [ ] Test unsubscribe functionality
  - [ ] Check email tracking dashboard

## Dev Notes

### Epic Context

This is Story 7.17 in Epic 7: Marketing Website & Landing Pages. This story creates professional email templates for all platform communication.

### Tech Stack

- **Email Service**: Resend (recommended) or SendGrid
- **Email Templates**: React Email (@react-email/components)
- **Language**: TypeScript
- **Database**: PostgreSQL with Prisma (for email preferences)

### Source Tree

- Email service: `lib/email.ts`
- Email templates: `emails/*.tsx`
- Email layout: `emails/components/email-layout.tsx`
- Unsubscribe page: `app/unsubscribe/page.tsx`
- Environment: `.env` (RESEND_API_KEY or SENDGRID_API_KEY)

### Email Service Setup

**Resend (Recommended)**:
```bash
pnpm add resend
pnpm add @react-email/components
```

**lib/email.ts**:
```typescript
import { Resend } from 'resend'
import WelcomeEmail from '@/emails/welcome-email'

const resend = new Resend(process.env.RESEND_API_KEY)

export async function sendWelcomeEmail(user: { email: string; name: string }, locale: 'en' | 'fr') {
  const EmailComponent = locale === 'fr' ? WelcomeEmailFR : WelcomeEmail

  await resend.emails.send({
    from: 'Survey Platform <no-reply@survey.fatihoune.com>',
    to: user.email,
    subject: locale === 'fr' ? 'Bienvenue sur Survey Platform' : 'Welcome to Survey Platform',
    react: EmailComponent({ name: user.name }),
  })
}
```

### React Email Template Example

**emails/welcome-email.tsx**:
```typescript
import {
  Body,
  Button,
  Container,
  Head,
  Heading,
  Html,
  Img,
  Link,
  Preview,
  Section,
  Text,
} from '@react-email/components'
import * as React from 'react'

interface WelcomeEmailProps {
  name: string
}

export default function WelcomeEmail({ name }: WelcomeEmailProps) {
  return (
    <Html>
      <Head />
      <Preview>Welcome to Survey Platform - Get started creating surveys</Preview>
      <Body style={main}>
        <Container style={container}>
          <Img
            src="https://survey.fatihoune.com/logo.png"
            width="150"
            height="50"
            alt="Survey Platform"
          />
          <Heading style={h1}>Welcome, {name}!</Heading>
          <Text style={text}>
            We're excited to have you on board. Let's get you started creating your first survey.
          </Text>
          <Section style={buttonContainer}>
            <Button style={button} href="https://survey.fatihoune.com/dashboard">
              Go to Dashboard
            </Button>
          </Section>
          <Text style={text}>
            <strong>Getting Started Tips:</strong>
          </Text>
          <ul>
            <li>Create your first survey using our drag-and-drop builder</li>
            <li>Choose from pre-built templates</li>
            <li>Share your survey link and collect responses</li>
          </ul>
          <Text style={footer}>
            © 2025 Survey Platform. All rights reserved.
          </Text>
        </Container>
      </Body>
    </Html>
  )
}

const main = { backgroundColor: '#f6f9fc', fontFamily: 'sans-serif' }
const container = { margin: '0 auto', padding: '20px 0 48px' }
const h1 = { fontSize: '32px', fontWeight: 'bold' }
const text = { fontSize: '16px', lineHeight: '26px' }
const button = {
  backgroundColor: '#5469d4',
  borderRadius: '4px',
  color: '#fff',
  fontSize: '16px',
  textDecoration: 'none',
  textAlign: 'center' as const,
  display: 'block',
  padding: '12px 24px',
}
const buttonContainer = { padding: '27px 0' }
const footer = { color: '#8898aa', fontSize: '12px' }
```

### Email Preferences in Database

Add to User model:
```prisma
model User {
  // ... existing fields
  emailPreferences Json? @default("{\"marketing\": true, \"transactional\": true}")
}
```

### Unsubscribe Page

```typescript
// app/unsubscribe/page.tsx
export default async function UnsubscribePage({
  searchParams,
}: {
  searchParams: { email: string; token: string }
}) {
  // Verify token and unsubscribe user
  // Update emailPreferences.marketing = false

  return (
    <div>
      <h1>You've been unsubscribed</h1>
      <p>You will no longer receive marketing emails from us.</p>
    </div>
  )
}
```

### Email Templates Summary

1. **Welcome Email**: Sent on registration
2. **Trial Expiring**: Sent 3 days before trial ends (cron job or scheduled task)
3. **Subscription Confirmation**: Sent after successful payment (Stripe webhook)
4. **Payment Failed**: Sent when payment fails (Stripe webhook)
5. **Contact Auto-Reply**: Sent after contact form submission
6. **Organization Invitation**: Already exists from Epic 5 (verify)

### Integration Points

- Welcome email sent from registration flow (Epic 1)
- Subscription emails sent from Stripe webhooks (Epic 6)
- Contact auto-reply sent from contact form (Story 7.9)
- Organization invitation from Epic 5 (Collaboration)

### Preview and Development

Use React Email dev server:
```bash
pnpm email:dev
```

This allows previewing all email templates at http://localhost:3000

### Testing

**Test File Location**: `__tests__/emails/*.test.tsx`

**Testing Standards**:
- Test email templates render correctly
- Mock Resend/SendGrid API
- Test email sending functions
- Verify both EN and FR versions
- Test unsubscribe functionality
- Manual testing: send test emails to real inbox

**Testing Frameworks**:
- Jest for test runner
- React Testing Library for component testing
- Mock Resend client

**Manual Testing**:
- Send test emails to personal email
- Verify rendering in Gmail, Outlook, Apple Mail
- Test on mobile and desktop
- Use Litmus or Email on Acid for cross-client testing (optional)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-06 | 1.0 | Initial story creation from Epic 7 | Sarah (PO Agent) |

## Dev Agent Record

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes

_To be filled by dev agent_

### File List

_To be filled by dev agent_

## QA Results

_To be filled by QA agent_
